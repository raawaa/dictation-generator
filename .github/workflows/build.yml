name: Build and Release Windows EXE

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v0.1.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥åˆ›å»º Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: get_version
      run: |
        if ("${{ github.ref }}" -like "refs/tags/*") {
          $version = "${{ github.ref }}" -replace "refs/tags/", ""
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
        } else {
          echo "version=dev" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 reportlab pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller build.spec

    - name: Rename EXE with version
      id: rename
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        if ($version -eq "dev") {
          $version = "dev"
        }
        $oldName = Get-ChildItem -Path "dist" -Filter "*.exe" | Select-Object -First 1 -ExpandProperty Name
        $newName = "dictation-generator-windows-$version.exe"
        Rename-Item -Path "dist\$oldName" -NewName $newName
        echo "exe_name=$newName" >> $env:GITHUB_OUTPUT
        echo "Renamed to: $newName"
      shell: pwsh

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dictation-generator-windows
        path: dist/*.exe
        retention-days: 30

    - name: Generate Changelog
      id: changelog
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        echo "Generating changelog for version $version"
        
        # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
        $prevTag = $(git describe --tags --abbrev=0 HEAD^ 2>$null)
        if ($LASTEXITCODE -ne 0) {
          $prevTag = ""
        }
        echo "Previous tag: $prevTag"
        
        # è·å–è‡ªä¸Šä¸€ä¸ªç‰ˆæœ¬ä»¥æ¥çš„æäº¤
        if ($prevTag) {
          $commits = git log $prevTag..HEAD --pretty=format:"%h|%s|%an|%ad" --date=short
        } else {
          $commits = git log --pretty=format:"%h|%s|%an|%ad" --date=short
        }
        
        # è§£ææäº¤ä¿¡æ¯å¹¶åˆ†ç±»
        $features = @()
        $fixes = @()
        $docs = @()
        $chores = @()
        $others = @()
        
        foreach ($commit in $commits) {
          if ($commit -match '^(.+)\|(.+)\|(.+)\|(.+)$') {
            $hash = $matches[1]
            $message = $matches[2]
            $author = $matches[3]
            $date = $matches[4]
            
            # è§£æ Conventional Commits æ ¼å¼
            if ($message -match '^(feat|fix|docs|chore|refactor|style|test|build|ci|perf|revert)(\(.+\))?:\s*(.+)') {
              $type = $matches[1]
              $scope = $matches[2]
              $desc = $matches[3]
              
              $entry = "- $desc ($hash)"
              
              switch ($type) {
                'feat' { $features += $entry }
                'fix' { $fixes += $entry }
                'docs' { $docs += $entry }
                'chore' { $chores += $entry }
                'refactor' { $others += $entry }
                'style' { $others += $entry }
                'test' { $others += $entry }
                'build' { $others += $entry }
                'ci' { $others += $entry }
                'perf' { $others += $entry }
                'revert' { $others += $entry }
              }
            } else {
              $others += "- $message ($hash)"
            }
          }
        }
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        $releaseBody = ""
        $releaseBody += "## è‹±è¯­å•è¯é»˜å†™çº¸ç”Ÿæˆå™¨ v$version`n`n"
        $releaseBody += "### ä¸‹è½½`n"
        $releaseBody += "- Windows ç‰ˆæœ¬ï¼š`dictation-generator-windows-$version.exe``n`n"
        $releaseBody += "### åŠŸèƒ½ç‰¹æ€§`n"
        $releaseBody += "- ä» CSV æ–‡ä»¶è¯»å–è¯æ±‡æ•°æ®`n"
        $releaseBody += "- æ”¯æŒæŒ‰å•å…ƒã€ç±»å‹ç­›é€‰`n"
        $releaseBody += "- éšæœºæŠ½å–æŒ‡å®šæ•°é‡è¯æ±‡`n"
        $releaseBody += "- ç”Ÿæˆ PDF æ ¼å¼é»˜å†™çº¸`n"
        $releaseBody += "- å›¾å½¢åŒ–ç•Œé¢æ“ä½œ`n`n"
        $releaseBody += "### ä½¿ç”¨è¯´æ˜`n"
        $releaseBody += "1. ä¸‹è½½ EXE æ–‡ä»¶`n"
        $releaseBody += "2. åŒå‡»è¿è¡Œ`n"
        $releaseBody += "3. é€‰æ‹© CSV æ–‡ä»¶å’Œé…ç½®å‚æ•°`n"
        $releaseBody += "4. ç‚¹å‡»ç”ŸæˆæŒ‰é’®å³å¯`n`n"
        $releaseBody += "### ç³»ç»Ÿè¦æ±‚`n"
        $releaseBody += "- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬`n`n"
        $releaseBody += "## å˜æ›´æ—¥å¿—`n`n"
        
        if ($features.Count -gt 0) {
          $releaseBody += "### âœ¨ æ–°åŠŸèƒ½`n`n"
          $features | ForEach-Object { $releaseBody += "$_`n" }
          $releaseBody += "`n"
        }
        
        if ($fixes.Count -gt 0) {
          $releaseBody += "### ğŸ› é—®é¢˜ä¿®å¤`n`n"
          $fixes | ForEach-Object { $releaseBody += "$_`n" }
          $releaseBody += "`n"
        }
        
        if ($docs.Count -gt 0) {
          $releaseBody += "### ğŸ“ æ–‡æ¡£æ›´æ–°`n`n"
          $docs | ForEach-Object { $releaseBody += "$_`n" }
          $releaseBody += "`n"
        }
        
        if ($chores.Count -gt 0) {
          $releaseBody += "### ğŸ”§ æ„å»º/å·¥å…·`n`n"
          $chores | ForEach-Object { $releaseBody += "$_`n" }
          $releaseBody += "`n"
        }
        
        if ($others.Count -gt 0) {
          $releaseBody += "### å…¶ä»–`n`n"
          $others | ForEach-Object { $releaseBody += "$_`n" }
          $releaseBody += "`n"
        }
        
        if ($features.Count -eq 0 -and $fixes.Count -eq 0 -and $docs.Count -eq 0 -and $chores.Count -eq 0 -and $others.Count -eq 0) {
          $releaseBody += "æ— å˜æ›´è®°å½•`n"
        }
        
        # å°†å˜æ›´æ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶
        $releaseBody | Out-File -FilePath "release_body.txt" -Encoding UTF8 -NoNewline
        
        # è¾“å‡ºå‰å‡ è¡Œç”¨äºè°ƒè¯•
        Get-Content "release_body.txt" | Select-Object -First 20
      shell: pwsh

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')  # ä»…åœ¨æ¨é€æ ‡ç­¾æ—¶åˆ›å»º Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*.exe
        name: Release ${{ steps.get_version.outputs.version }}
        body_path: release_body.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}